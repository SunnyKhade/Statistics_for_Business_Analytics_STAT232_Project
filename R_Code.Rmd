---
title: "Project Proposal for nycflights13 Dataset Analysis"
author: "Red Squadron"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

# Introduction

The objective of this project is to analyze the `nycflights13` dataset to gain insights into flight patterns, delays, and related phenomena. The overarching goal is to answer key questions about the factors influencing flight delays and performance. By the end of the project, we aim to provide actionable insights for stakeholders, including airlines, passengers, and airport authorities.

# Research Questions and Objectives

We aim to answer the following research questions:

1.  Which departure airports experience the longest delays, and what factors contribute to these delays?
2.  How does the time of departure (morning, afternoon, evening) impact the likelihood of delays?
3.  Are there significant differences in on-time performance between different airlines?
4.  How does weather (e.g., temperature, precipitation) affect flight delays?
5.  What is the relationship between flight distance and delay duration?
6.  How do delays vary across different seasons and holidays?
7.  Can predictive models help estimate delays based on factors such as flight schedule and carrier?

To achieve these goals, we have formulated the following specific research aims:

-   Conduct exploratory data analysis to understand the distribution of delays.
-   Identify key variables impacting flight performance.
-   Perform time-series analysis to detect patterns over months and days.
-   Develop predictive models to forecast delays.

# Dataset Overview

The primary dataset for this analysis is `nycflights13`. It contains detailed information on all flights departing from New York City airports in 2013.

```{r,collapse=T}
library(nycflights13)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(caret)
library(randomForest)
# Summary of the flights dataset
flights_summary <- flights %>% summarise(rows = n(), columns = ncol(flights))
print(flights_summary)
```

The dataset contains `r flights_summary$rows` rows and `r flights_summary$columns` columns. Key variables include:

-   `year`, `month`, `day`: Date of the flight.
-   `dep_time`, `arr_time`: Departure and arrival times.
-   `carrier`: Airline carrier code.
-   `flight`: Flight number.
-   `origin`, `dest`: Origin and destination airports.
-   `air_time`, `distance`: Flight duration and distance.
-   `dep_delay`, `arr_delay`: Departure and arrival delays.

# Exploratory Data Analysis

We performed initial exploratory analysis to understand the distribution and relationships between key variables.

## Summary Statistics

```{r summary_stats, collapse = TRUE}
summary(flights)
glimpse(flights)
```

## Distribution of Arrival Delays

```{r arrival_delay_plot, collapse = TRUE}
library(ggplot2)

# Plotting the distribution of arrival delays
flights %>% 
  filter(!is.na(arr_delay)) %>% 
  ggplot(aes(x = arr_delay)) + 
  geom_histogram(binwidth = 10, fill = "skyblue", color = "black") + 
  labs(title = "Distribution of Arrival Delays", x = "Arrival Delay (minutes)", y = "Count")
```

## Comparison of Delays by Airline

```{r airline_comparison, collapse = TRUE}
# Bar plot showing average arrival delay by airline
flights %>% 
  filter(!is.na(arr_delay)) %>% 
  group_by(carrier) %>% 
  summarise(mean_arr_delay = mean(arr_delay, na.rm = TRUE)) %>% 
  ggplot(aes(x = reorder(carrier, -mean_arr_delay), y = mean_arr_delay)) + 
  geom_bar(stat = "identity", fill = "orange") + 
  labs(title = "Average Arrival Delay by Airline", x = "Airline", y = "Average Delay (minutes)") + 
  coord_flip()
```

## Delays by Month

```{r monthly_delay_plot, collapse = TRUE}
# Time series plot of average delays by month
flights %>% 
  filter(!is.na(arr_delay)) %>% 
  group_by(month) %>% 
  summarise(avg_arr_delay = mean(arr_delay, na.rm = TRUE)) %>% 
  ggplot(aes(x = month, y = avg_arr_delay)) + 
  geom_line(color = "blue", size = 1) + 
  geom_point(color = "red", size = 2) + 
  labs(title = "Average Arrival Delay by Month", x = "Month", y = "Average Delay (minutes)")
```

# Data Cleaning

The dataset contains some missing and erroneous values, particularly in columns related to delays and times. We plan to clean the data by:

-   Removing rows with missing `dep_delay` or `arr_delay` values.
-   Filtering out flights with extreme outliers in delay times.

# Methodology

To answer the research questions, we will employ the following methods:

1.  **Descriptive Analysis:** Summary statistics and visualizations to understand trends and distributions.
2.  **Correlation Analysis:** Identifying relationships between variables such as distance, delay, and carrier.
3.  **Time Series Analysis:** Examining seasonal and daily patterns in flight delays.
4.  **Predictive Modeling:**

-   We plan to build regression and classification models to predict delays.
-   Models may include linear regression, decision trees, and random forests.

## Example Correlation Analysis

```{r correlation_analysis, collapse = TRUE}
# Calculate correlation between distance and arrival delay
correlation <- cor(flights$distance, flights$arr_delay, use = "complete.obs")
cat("Correlation between flight distance and arrival delay: ", correlation)
```
# How do departure times impact delays? 
```{r}
flights_C <- flights %>% 
  drop_na() 
```

```{r}
flights_1 <- flights %>%
  slice(1:30000) %>%                
  drop_na(dep_time, dep_delay) %>% 
  mutate(
    dep_time_decimal = (dep_time %/% 100) + (dep_time %% 100) / 60)

```


```{r}
ggplot(flights_1, aes(x = dep_time_decimal, y = dep_delay)) +
  geom_point(alpha = 0.1, col = "blue") +
  geom_smooth(col = "red") +
  labs (x = "dep_time")
```
```{r}
flights_d <- flights |>
  slice(1:15000) |>    
  drop_na(dep_time, dep_delay) |>  
  filter(dep_delay >= 0) |>  
  mutate(
    dep_time_decimal = (dep_time %/% 100) + (dep_time %% 100) / 60,
    time_bin = cut(dep_time_decimal, breaks = seq(0, 24, by = 1), include.lowest = TRUE),
    delay_bin = cut(dep_delay, breaks = seq(0, 120, by = 30), include.lowest = TRUE)
  ) |>
  # Remove rows with NA in bins (e.g., delays >120 minutes or edge cases)
  filter(!is.na(time_bin), !is.na(delay_bin)) |>  
  group_by(time_bin, delay_bin) |>  
  summarise(count = n(), .groups = "drop")

ggplot(flights_d, aes(x = time_bin, y = delay_bin, fill = count)) +
  geom_tile() +    
  scale_fill_viridis_c(option = "viridis", name = "Flights") +  
  labs(x = "Departure Time (Hour of Day)", y = "Departure Delay") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
flights_r <- flights %>%
  slice(1000:3000) %>%                  
  drop_na(dep_time, dep_delay) %>%    
  mutate(dep_hour = dep_time %/% 100)

modeldh <- lm(dep_delay ~ dep_time + (dep_time^2), data = flights_r)


summary(modeldh)
```
```{r}
flights_a <- flights %>%
  slice(1000:3000) %>%                  
  drop_na(dep_time, arr_delay) %>%    
  mutate(dep_hour = dep_time %/% 100)

modeldd <- lm(arr_delay ~ dep_time + (dep_time^2), data = flights_a)


summary(modeldd)
```
```{r}
flights %>% 
  filter(!is.na(arr_delay)) %>% 
  group_by(day) %>% 
  summarise(avg_arr_delay = mean(arr_delay, na.rm = TRUE)) %>% 
  ggplot(aes(x = day, y = avg_arr_delay)) + 
  geom_line() + 
  geom_point(color = "red", size = 2)
```
```{r}
flights_r <- flights %>%
  slice(1000:3000) %>%                  
  drop_na(dep_time, arr_delay) %>%    
  mutate(dep_hour = dep_time %/% 100)

modeldr <- lm(arr_delay ~ dep_time + (dep_time^2), data = flights_r)


summary(modeldr)
```

# Potential Visualizations

-   Scatter plots of delays vs. flight distance.
-   Time series plots showing average delays by month.
-   Bar plots comparing delays by carrier and destination.

# Alternative Strategies / Backup Plans

If our initial analysis does not yield conclusive results, we will consider the following alternative strategies:

1.  **Focus on Weather Data:** Integrate external weather data to explore its impact on delays.

-   Collect historical weather data for NYC in 2013.
-   Analyze how weather conditions (e.g., storms, visibility) affect delays.

2.  **Airline Performance Comparison:**

-   Concentrate on ranking airlines based on delay metrics.
-   Perform detailed case studies on the top-performing and worst-performing airlines.

3.  **Airport-Specific Analysis:**

-   Analyze each NYC airport separately to identify unique patterns.
-   Examine how traffic congestion and infrastructure influence delays.

# Expected Outcomes

We expect to uncover significant patterns in flight delays that could inform decision-making for airlines and airports. Predictive models should help stakeholders anticipate delays and improve operational efficiency.

# Conclusion

This project will provide a comprehensive analysis of the `nycflights13` dataset. By answering the research questions through a combination of exploratory data analysis, visualization, and modeling, we aim to generate valuable insights into flight performance and delays. The findings will be shared in the final project report and presentation.

```{r final_summary, collapse = TRUE}
# Final steps: Displaying key results summary
cat("Proposal complete. Next steps involve deeper analysis and model implementation.")
```
## Objective and Research Questions

```{r}
# Clearly define the objective
cat("### Objective: \n",
    "The objective of this study is to analyze flight delays using the NYCFlights13 dataset. Our research aims to:\n",
    "1. Identify key factors influencing flight delays, such as departure time, airline performance, and weather conditions.\n",
    "2. Provide insights that can help airlines optimize scheduling and improve on-time performance.\n",
    "3. Assist passengers in making informed travel decisions by understanding patterns of delays.\n",
    "4. Lay the groundwork for predictive modeling of flight delays, which can aid in operational planning for airlines and airports.\n")
```

## Exploratory Data Analysis (EDA)

### **1. Distribution of Delays**
```{r}
flights %>% 
  filter(dep_delay < 240, arr_delay < 240) %>%  # Removing extreme outliers
  ggplot(aes(x = dep_delay)) + 
  geom_histogram(binwidth = 5, fill = "steelblue", color = "black") + 
  labs(title = "Distribution of Departure Delays", x = "Departure Delay (minutes)", y = "Count")
```

### **2. Delays by Time of Day**
```{r}
flights %>%
  mutate(sched_dep_time = sprintf("%04d", sched_dep_time),  # Convert to string with 4 digits
         sched_dep_time = paste0(substr(sched_dep_time, 1, nchar(sched_dep_time) - 2), ":", 
                                 substr(sched_dep_time, nchar(sched_dep_time) - 1, nchar(sched_dep_time))),  # Convert HHMM to HH:MM
         dep_hour = as.numeric(substr(sched_dep_time, 1, 2))) %>%  # Extract only the hour
  group_by(dep_hour) %>%
  summarise(mean_dep_delay = mean(dep_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = dep_hour, y = mean_dep_delay)) + 
  geom_line(color = "red", size = 1) + 
  labs(title = "Average Departure Delay by Hour of Day", x = "Hour of Departure", y = "Avg Departure Delay (minutes)")
```

### **3. Impact of Weather on Delays**
```{r}
# Joining with weather data
weather_flights <- flights %>% 
  inner_join(weather, by = c("year", "month", "day", "origin"))

# Scatter plot of wind speed vs delay
weather_flights %>% 
  ggplot(aes(x = wind_speed, y = dep_delay)) + 
  geom_point(alpha = 0.3, color = "blue") +
  geom_smooth(method = "lm", se = FALSE, color = "red") + 
  labs(title = "Effect of Wind Speed on Departure Delays", x = "Wind Speed (mph)", y = "Departure Delay (minutes)")
```

### **4. Top Airports with Highest Delays**
```{r}
flights %>%
  group_by(origin) %>%
  summarise(mean_dep_delay = mean(dep_delay, na.rm = TRUE)) %>%
  arrange(desc(mean_dep_delay)) %>%
  ggplot(aes(x = reorder(origin, mean_dep_delay), y = mean_dep_delay, fill = origin)) +
  geom_col() +
  coord_flip() +
  labs(title = "Average Departure Delays by NYC Airports", x = "Airport", y = "Avg Departure Delay (minutes)")
```

### **5. Airline Performance**
```{r}
flights %>%
  group_by(carrier) %>%
  summarise(mean_arr_delay = mean(arr_delay, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(carrier, mean_arr_delay), y = mean_arr_delay, fill = carrier)) +
  geom_col() +
  coord_flip() +
  labs(title = "Airline Performance: Average Arrival Delays", x = "Airline", y = "Avg Arrival Delay (minutes)")
```

## **Hypothesis Testing**

### **1. Does Departure Time Affect Delays?**
**Hypothesis:**
- \(H_0\): Departure time has no impact on delays.
- \(H_A\): Departure time significantly impacts delays.

```{r}
flights_transformed <- flights %>%
  mutate(sched_dep_time = sprintf("%04d", sched_dep_time),  # Convert to string with 4 digits
         sched_dep_time = paste0(substr(sched_dep_time, 1, nchar(sched_dep_time) - 2), ":", 
                                 substr(sched_dep_time, nchar(sched_dep_time) - 1, nchar(sched_dep_time))),  # Convert HHMM to HH:MM
         dep_hour = as.numeric(substr(sched_dep_time, 1, 2)))  # Extract only the hour

# Now run the model on `flights_transformed`
model <- lm(dep_delay ~ dep_hour, data = flights_transformed)
summary(model)

```

### **2. Does Weather Affect Delays?**
**Hypothesis:**
- \(H_0\): Weather variables do not significantly impact flight delays.
- \(H_A\): Weather variables significantly impact flight delays.

```{r}
model_weather <- lm(dep_delay ~ wind_speed + precip + temp, data = weather_flights)
summary(model_weather)
```

## **Conclusion and Next Steps**
```{r}
cat("### Conclusion & Next Steps: \n",
    "- Departure delays show a non-linear trend with departure time. \n",
    "- Weather conditions (wind speed, precipitation) have a significant effect on delays. \n",
    "- Future work: Improve delay prediction using machine learning models.")
```
1 #Data preparation

```{r}

# Transform dataset to extract relevant features
flights_transformed <- flights %>%
  mutate(sched_dep_time = sprintf("%04d", sched_dep_time),  # Ensure HHMM format
         sched_dep_time = paste0(substr(sched_dep_time, 1, nchar(sched_dep_time) - 2), ":", 
                                 substr(sched_dep_time, nchar(sched_dep_time) - 1, nchar(sched_dep_time))),  # Convert HHMM to HH:MM
         dep_hour = as.numeric(substr(sched_dep_time, 1, 2)),  # Extract departure hour
         day_of_week = wday(time_hour, label = TRUE),  # Extract day of the week
         month = month(time_hour)) %>%  # Extract month
  select(dep_delay, dep_hour, month, day_of_week, origin, dest, carrier)

# Remove missing values
flights_transformed <- na.omit(flights_transformed)

```

2 #Splitting data
```{r}

set.seed(123)  # Set seed for reproducibility
trainIndex <- createDataPartition(flights_transformed$dep_delay, p = 0.8, list = FALSE)
train_data <- flights_transformed[trainIndex, ]
test_data <- flights_transformed[-trainIndex, ]

```

3 #Training a Random Forest Model

```{r}

set.seed(123)  # Ensure consistent results
rf_model <- randomForest(dep_delay ~ dep_hour + month + day_of_week + origin + dest + carrier, 
                         data = train_data, 
                         ntree = 100,  # Number of trees
                         importance = TRUE)

```

4 #Model Evaluation

```{r}

# Make predictions on test data
predictions <- predict(rf_model, test_data)

# Compute evaluation metrics
mae <- mean(abs(predictions - test_data$dep_delay))
rmse <- sqrt(mean((predictions - test_data$dep_delay)^2))
r_squared <- cor(predictions, test_data$dep_delay)^2

# Print performance metrics
cat("Model Performance Metrics:\n")
cat("Mean Absolute Error (MAE):", round(mae, 2), "minutes\n")
cat("Root Mean Squared Error (RMSE):", round(rmse, 2), "minutes\n")
cat("R-squared (R²):", round(r_squared, 2), "\n")

```

5 #Feature Importance

```{r}

# Show variable importance
importance(rf_model)
varImpPlot(rf_model)

```

# Conclusion

```{r}

cat("### Conclusion:\n",
    "- The Random Forest model captures complex relationships in flight delay data.\n",
    "- Performance metrics indicate moderate predictive power, suggesting room for improvement.\n",
    "- Additional predictors such as weather conditions and aircraft type could enhance accuracy.\n",
    "- Future models will explore Gradient Boosting Machines (GBM) and Neural Networks for further optimization.")

```

